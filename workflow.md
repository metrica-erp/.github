# Workflow: Code Review & Development Process

**Проект Метрика | Версия 2.1**

---

## 1. Жизненный цикл задачи

```
Яндекс Трекер                        GitHub
─────────────                         ──────
Беклог
  ↓
Будем делать ──→ Создаёшь ветку ──→ Draft PR
  ↓                                     ↓
В работе ◄──── Пишешь код ────────► Коммиты
  ↓                                     ↓
Ревью ◄──────── Ready for Review ──► Code Review
  ↓                                     ↓
Можно тестировать ◄── Approve ──────► Squash & Merge
  ↓
Готово
```

---

## 2. Начало работы: от задачи к ветке

1. Берёшь задачу в Яндекс Трекере (например, MCA-42)
2. Убедись, что заполнены **обязательные поля** при переходе в «В работе»:
   - Компоненты (Frontend / Backend)
   - Теги (bug / feature / tech debt / hotfix / documentation)
   - Исполнитель
   - Story Points
3. Создаёшь ветку от `development`:

```bash
git checkout development && git pull
git checkout -b feature/MCA-42-название-задачи
```

### Именование веток

| Тип | Шаблон | Пример |
|-----|--------|--------|
| Фича | `feature/MCA-XX-описание` | `feature/MCA-42-pinned-tabs` |
| Баг | `bugfix/MCA-XX-описание` | `bugfix/MCA-15-filter-crash` |
| Хотфикс | `hotfix/MCA-XX-описание` | `hotfix/MCA-99-auth-fix` |
| Техдолг | `chore/MCA-XX-описание` | `chore/MCA-30-typescript-migration` |

---

## 3. Pull Request: создание и оформление

### Когда создавать PR

**Сразу после первого коммита** — как Draft (черновик).

Draft PR означает: «я работаю, код ещё не готов, но можно посмотреть прогресс». Кнопка Merge в Draft PR заблокирована.

```bash
git push -u origin feature/MCA-42-pinned-tabs
# → GitHub → «Compare & pull request» → стрелка → «Create draft pull request»
```

### Размер PR

**Рекомендуемый максимум: 400 строк изменений.** Если получается больше — разбей задачу на несколько PR. Маленькие PR = быстрый и качественный ревью.

Исключения: миграции, сгенерированный код, перемещение файлов — не считаются.

### Шаблон PR

В репозитории создан файл `.github/PULL_REQUEST_TEMPLATE.md`. GitHub автоматически подставляет шаблон при создании PR. Разработчику нужно только заполнить поля.

### Лейблы на PR

Тип и область изменений указываются **лейблами**, а не в теле PR. Автор обязан повесить лейблы при создании PR.

| Лейбл | Когда использовать |
|-------|-------------------|
| `bug` | Исправление ошибки |
| `feature` | Новая функциональность |
| `tech debt` | Рефакторинг, оптимизация |
| `hotfix` | Срочное исправление |
| `docs` | Документация |
| `frontend` | Изменения во frontend |
| `backend` | Изменения в backend |
| `urgent` | Нужен быстрый ревью (SLA: 2 часа) |

---

## 4. Самопроверка перед ревью (Definition of Done)

**Перед нажатием «Ready for review» разработчик ОБЯЗАН** пройти чеклист в PR-шаблоне:

### Общее
- Проект собирается без ошибок
- Код отформатирован, линтер чистый
- Удалены `console.log` / `print` / отладочные комментарии
- Понятные названия переменных и функций
- Нет захардкоженных значений

### Frontend
- Проверена адаптивность
- Нет лишних ре-рендеров
- Стили через дизайн-токены

### Backend
- Миграции корректны
- API эндпоинты протестированы
- Нет секретов в коде

### Финальное подтверждение
- **«Я подтверждаю, что проверил все изменения, код не ломает существующий функционал и готов к ревью»**

> Цель самопроверки — убрать из ревью тупые замечания (забытые логи, форматирование) и сфокусировать ревьюера на логике и архитектуре.

---

## 5. Код-ревью

### Текущие цепочки ревью

| Область | Цепочка |
|---------|---------|
| Frontend | Ильназ → Владимир → Даниил |
| Backend | Разработчик → Евгений |

Ревьюеры назначаются через **GitHub UI** (панель Reviewers справа в PR).

### SLA на ревью

| Лейбл | Время на начало ревью |
|-------|----------------------|
| `urgent` | **2 рабочих часа** |
| Обычный PR | **4 рабочих часа** |

Если ревьюер не может уложиться в SLA — пишет в чат и передаёт следующему в цепочке.

### Процесс

1. Автор заканчивает работу → нажимает **«Ready for review»**
2. Автор назначает ревьюеров через GitHub UI
3. **Ревьюер 1** проверяет код:
   - Всё ок → **Approve**
   - Есть замечания → **Request changes** с конкретными предложениями через «Suggest changes»
4. Автор исправляет, пушит новые коммиты
5. **Ревьюер 2** (если есть) проверяет → **Approve**
6. Последний ревьюер делает **Squash and Merge**

### Правила

- Автор **НЕ может** сам замержить свой PR — только ревьюер после Approve
- Новые коммиты после Approve **сбрасывают** одобрение → нужен повторный ревью
- Комментарии в ревью — это командная работа, не критика
- Если автор не согласен с замечанием — обсуждает в треде, не игнорирует

### На что смотрит ревьюер

- Код решает задачу, описанную в PR?
- Нет дублирования кода
- Понятные названия переменных и функций
- Нет захардкоженных значений
- Бэкенд: миграции корректны
- Фронтенд: адаптивность, токены вместо хардкода
- Нет проблем с безопасностью

---

## 6. Merge и деплой

### Стратегия мержа

**Squash and Merge** — все коммиты из ветки сжимаются в один. История остаётся чистой.

### Ветки

| Ветка | Назначение |
|-------|-----------|
| `development` | Основная ветка разработки, сюда идут все PR |
| `main` | Продакшн — только проверенный код |

### Маршрут (обычный)

```
feature/MCA-42 → development → main (прод)
```

### Маршрут (hotfix)

Для срочных исправлений в продакшне:

```
hotfix/MCA-99 → main (1 ревьюер, ускоренный процесс)
                  ↓
            cherry-pick → development
```

Hotfix-правила:
- Ветка от `main`, PR в `main`
- Достаточно **1 approve** (любой из цепочки)
- Лейбл `hotfix` + `urgent`
- После мержа в main — обязательный cherry-pick в `development`

### После мержа

1. Обновить статус задачи в Трекере → «Можно тестировать»
2. Удалить feature-ветку (GitHub предложит автоматически)
3. Убедиться, что CI/CD прошёл успешно

---

## 7. Связка GitHub ↔ Яндекс Трекер

Пока интеграция ручная:

- **В PR** — ссылка на задачу в Трекере (через шаблон)
- **В задаче** — ссылка на PR в комментарии
- **Лейблы** в GitHub соответствуют тегам из Трекера

### Автоматизация в Трекере (настроенные триггеры)

| Триггер | Условие | Действие |
|---------|---------|----------|
| Автозакрытие эпика | Все подзадачи в «Готово» | Эпик → «Готово» |
| Чеклист → Ревью | Все пункты чеклиста выполнены | Задача → «Ревью» |

---

## 8. Настройки репозитория

### Сделать сразу (бесплатно)

- [ ] Создать `.github/PULL_REQUEST_TEMPLATE.md`
- [ ] Создать лейблы: `bug`, `feature`, `tech debt`, `hotfix`, `docs`, `frontend`, `backend`, `urgent`
- [ ] Ознакомить команду с этим документом

### Приоритет 1: GitHub Pro ($4/мес)

> Branch protection — единственный способ enforcement правил. Без него всё держится на доверии.

- [ ] Подключить GitHub Pro
- [ ] Branch Protection для `main`:
  - Require pull request before merging
  - Require approvals (минимум 1)
  - Dismiss stale approvals when new commits are pushed
  - Do not allow bypassing the above settings
- [ ] Branch Protection для `development`:
  - Require pull request before merging
  - Require approvals (минимум 1)

### Приоритет 2: автоматизация

- [ ] CODEOWNERS для автоназначения ревьюеров
- [ ] GitHub Actions: при мерже PR → автоматический перевод задачи в Трекере
- [ ] Require status checks (линтер, сборка) перед мержем

---

## Краткая памятка

| Этап | Кто | Что делает |
|------|-----|-----------|
| Задача | Разработчик | Берёт задачу, заполняет обязательные поля, создаёт ветку |
| Draft PR | Разработчик | Создаёт черновик PR после первого коммита, вешает лейблы |
| Код | Разработчик | Пишет код, коммитит (PR до 400 строк) |
| Самопроверка | Разработчик | Проходит чеклист из PR-шаблона |
| Ready | Разработчик | Нажимает «Ready for review», назначает ревьюеров |
| Ревью | Ревьюер(ы) | Начинает проверку в течение 4 часов |
| Approve | Ревьюер | Одобряет PR |
| Merge | Последний ревьюер | Squash and Merge |
| Трекер | Разработчик | Обновляет статус → «Можно тестировать» |
